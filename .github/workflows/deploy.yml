name: Deploy PlacementPro Full Stack to AWS EC2

on:
  push:
    branches: [ main ]

jobs:
  # This job performs a basic check on the Python code.
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4  # Updated version

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies with retry logic
      run: |
        python -m pip install --upgrade pip
        pip install --timeout=1000 --retries=5 --index-url https://pypi.org/simple/ -r requirements.txt

    - name: Test FastAPI app
      run: |
        python -c "from main import app; print('âœ… App loads successfully')"

  # This job builds the Docker image and deploys it to the EC2 instance.
  deploy:
    needs: test
    runs-on: ubuntu-latest
    env:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
    steps:
    - uses: actions/checkout@v4

    - name: Clean up Docker space on runner
      run: |
        echo "ğŸ§¹ Cleaning up disk space on GitHub runner..."
        docker system prune -af || true

    - name: Build and push Docker image
      run: |
        echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        echo "ğŸ³ Building complete PlacementPro image..."
        docker build --network=host -t "$DOCKER_USERNAME/placementpro:latest" .
        echo "ğŸ“¤ Pushing Docker image..."
        docker push "$DOCKER_USERNAME/placementpro:latest"
        echo "âœ… Docker image pushed successfully"

    # Create the deployment script
    - name: Create deployment script
      run: |
        cat > deploy.sh << 'EOL'
        #!/bin/bash
        set -e
        
        echo "ğŸ§¹ Cleaning up disk space on EC2 instance..."
        sudo docker system prune -af --volumes || true
        sudo journalctl --vacuum-time=2d || true
        df -h

        cd /home/ec2-user/placementpro || (mkdir -p /home/ec2-user/placementpro && cd /home/ec2-user/placementpro)

        echo "ğŸ›‘ Stopping and removing old container and processes..."
        sudo docker stop placementpro 2>/dev/null || true
        sudo docker rm placementpro 2>/dev/null || true
        
        # More robust port cleanup
        for port in 3000 5000 8000 80; do
          if sudo lsof -ti:$port 2>/dev/null; then
            echo "Killing processes on port $port"
            sudo lsof -ti:$port | xargs -r sudo kill -9 2>/dev/null || true
          fi
        done

        echo "ğŸ“¥ Pulling latest Docker image..."
        sudo docker pull $1/placementpro:latest

        # Create required directories
        mkdir -p temp static/reports static/summaries static/transcripts

        echo "ğŸš€ Starting new PlacementPro container..."
        sudo docker run -d \
          --name placementpro \
          -p 80:3000 \
          -p 3000:3000 \
          -p 5000:5000 \
          -p 8000:8000 \
          -v $(pwd)/temp:/app/temp \
          -v $(pwd)/static:/app/static \
          --restart unless-stopped \
          --memory="3g" \
          --cpus="2.0" \
          --health-cmd="curl -f http://localhost:8000/api/health || exit 1" \
          --health-interval=30s \
          --health-timeout=10s \
          --health-retries=3 \
          $1/placementpro:latest

        if [ $? -ne 0 ]; then
          echo "âŒ Container failed to start. Checking logs and port conflicts..."
          for port in 3000 5000 8000; do
            if sudo lsof -i:$port 2>/dev/null; then
              echo "âŒ Port $port is still in use"
              sudo lsof -i:$port
            else
              echo "âœ… Port $port is free"
            fi
          done
          sudo docker logs placementpro 2>/dev/null || echo "No logs available for failed container."
          exit 1
        fi

        echo "â³ Waiting for container to become healthy..."
        for i in {1..20}; do
          if [ "$(sudo docker inspect --format '{{.State.Health.Status}}' placementpro 2>/dev/null)" = "healthy" ]; then
            echo "âœ… Container is healthy!"
            break
          fi
          echo "Container health check... (Attempt $i/20)"
          sleep 15
          if [ $i -eq 20 ]; then
            echo "âŒ Container did not become healthy in time."
            sudo docker logs placementpro --tail 50
            exit 1
          fi
        done

        echo "ğŸ§ª Testing all services..."
        
        # Backend health check
        echo "ğŸ”§ Testing Backend API..."
        for i in {1..12}; do
          if curl -f -s http://localhost:8000/api/health > /dev/null; then
            echo "âœ… Backend API: Working!"
            break
          fi
          echo "â³ Backend API attempt $i/12..."
          sleep 10
          if [ $i -eq 12 ]; then
            echo "âŒ Backend API failed after 12 attempts"
            sudo docker logs placementpro --tail 50
            exit 1
          fi
        done

        # Frontend health check
        echo "ğŸ¨ Testing Frontend..."
        for i in {1..10}; do
          if curl -f -s http://localhost:3000 > /dev/null; then
            echo "âœ… Frontend: Working!"
            break
          fi
          echo "â³ Frontend attempt $i/10..."
          sleep 15
        done

        # Chat server health check
        echo "ğŸ’¬ Testing Chat Server..."
        for i in {1..8}; do
          if command -v nc >/dev/null 2>&1 && nc -z localhost 5000; then
            echo "âœ… Chat Server: Port is open!"
            break
          elif timeout 5 bash -c "</dev/tcp/localhost/5000" 2>/dev/null; then
            echo "âœ… Chat Server: Port is accessible!"
            break
          fi
          echo "â³ Chat server attempt $i/8..."
          sleep 10
          if [ $i -eq 8 ]; then
            echo "âš ï¸ Chat Server port check inconclusive."
          fi
        done

        echo ""
        echo "ğŸ“Š Final deployment status:"
        echo "ğŸ³ Container Status:"
        sudo docker ps --filter name=placementpro --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        echo ""
        echo "ğŸ“ˆ Resource Usage:"
        sudo docker stats placementpro --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}"
        echo ""
        echo "ğŸ“‹ Recent Service Logs:"
        sudo docker logs placementpro --tail 30

        echo ""
        echo "ğŸ‰ Complete PlacementPro platform deployed successfully!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸŒ MAIN WEBSITE: http://$2"
        echo "ğŸ“– API Documentation: http://$2:8000/docs"
        echo "ğŸ¥ Health Check: http://$2:8000/api/health"
        echo "ğŸ’¬ Chat Server: ws://$2:5000"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        EOL
        chmod +x deploy.sh

    # Deploy using SSH with a more reliable action
    - name: Deploy to EC2
      uses: easingthemes/ssh-deploy@v4.1.10
      with:
        SSH_PRIVATE_KEY: ${{ secrets.EC2_PRIVATE_KEY }}
        REMOTE_HOST: ${{ secrets.EC2_HOST }}
        REMOTE_USER: ec2-user
        SOURCE: "deploy.sh"
        TARGET: "/home/ec2-user"
        SCRIPT_AFTER: "cd /home/ec2-user && bash deploy.sh ${{ secrets.DOCKER_USERNAME }} ${{ secrets.EC2_HOST }}"
